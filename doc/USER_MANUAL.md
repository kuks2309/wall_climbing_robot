# Robotmaster C620 모터 제어 시스템 사용설명서

## 목차
1. [시스템 개요](#시스템-개요)
2. [필요 장비](#필요-장비)
3. [하드웨어 연결](#하드웨어-연결)
4. [소프트웨어 설치](#소프트웨어-설치)
5. [Arduino 펌웨어 업로드](#arduino-펌웨어-업로드)
6. [제어 프로그램 실행](#제어-프로그램-실행)
7. [사용 방법](#사용-방법)
8. [문제 해결](#문제-해결)
9. [기술 사양](#기술-사양)

---

## 시스템 개요

이 시스템은 Arduino Mega를 사용하여 DJI RoboMaster C620 ESC를 통해 2개의 BLDC 모터를 제어합니다.
PyQt5 기반 GUI 애플리케이션을 통해 직관적으로 모터를 제어할 수 있습니다.

### 주요 특징
- PWM 신호 기반 모터 제어 (1000~2000μs)
- C620 전용 중립값 1444μs 자동 설정
- Big-endian 프로토콜 기반 안정적인 통신
- 실시간 로그 및 디버깅 기능
- 직관적인 GUI 인터페이스

### ⚠️ 중요: 초기 펄스 폭 설정

**DJI C620 ESC는 초기 펄스 폭이 매우 중요합니다!**

```
🔴 일반 ESC: 중립값 1500μs
🟢 C620 ESC: 중립값 1444μs ← 반드시 이 값 사용!
```

**왜 중요한가요?**
1. **잘못된 중립값 = 모터 작동 불가**: C620은 정확히 1444μs가 아니면 모터가 전혀 반응하지 않습니다
2. **자동 설정**: 이 시스템은 부팅 시 자동으로 1444μs로 초기화됩니다
3. **수동 조정 금지**: 코드에서 중립값을 임의로 변경하지 마세요

**확인 방법:**
- Arduino 코드 19-20번 라인: `pwm_command1.pulsewidth = 1444;`
- Python 코드 57, 62번 라인: `setValue(1444)`
- UI 파일 183, 300번 라인: `<number>1444</number>`

---

## 필요 장비

### 하드웨어
1. **Arduino Mega 2560** - 메인 컨트롤러
2. **DJI RoboMaster C620 ESC** x2 - 모터 드라이버
3. **BLDC 모터** x2 - M3508 또는 호환 모터
4. **전원 공급 장치** - 24V DC (C620 권장)
5. **USB 케이블** - Arduino 연결용
6. **점퍼 와이어** - 신호선 연결용

### 소프트웨어
1. **Arduino IDE** - 펌웨어 업로드용
2. **Python 3.7 이상**
3. **PyQt5** - GUI 라이브러리
4. **pyserial** - 시리얼 통신 라이브러리

---

## 하드웨어 연결

### Arduino Mega 연결

```
Arduino Mega          C620 ESC #1       C620 ESC #2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Digital Pin 2    →    PWM 신호선
Digital Pin 4    →                      PWM 신호선
GND              →    GND               GND

PC (USB)         →    Serial0 (디버그)
C620/외부장치    →    Serial1 (제어, Pin 18/19)
```

### 전원 연결
1. **C620 전원**: 24V DC 전원을 C620에 연결
2. **Arduino 전원**: USB 또는 외부 12V 전원
3. **절대 모터 전원과 Arduino 전원을 직접 연결하지 마세요!**

### 신호선 연결
- C620의 PWM 신호선(흰색/노란색)을 Arduino Digital Pin에 연결
- 반드시 Arduino GND와 C620 GND를 공통 연결

---

## 소프트웨어 설치

### 1. Arduino IDE 설치
```bash
# Linux
sudo apt-get install arduino

# macOS
brew install --cask arduino

# Windows
https://www.arduino.cc/en/software 에서 다운로드
```

### 2. Python 패키지 설치
```bash
# PyQt5 설치
pip install PyQt5

# pyserial 설치
pip install pyserial
```

### 3. 프로젝트 클론
```bash
git clone https://github.com/kuks2309/wall_climbing_robot.git
cd wall_climbing_robot
```

---

## Arduino 펌웨어 업로드

### 1. Arduino IDE 설정
1. Arduino IDE 실행
2. **도구 > 보드 > Arduino Mega or Mega 2560** 선택
3. **도구 > 포트**에서 Arduino가 연결된 포트 선택
4. **도구 > 프로세서 > ATmega2560** 선택

### 2. 펌웨어 열기
1. `파일 > 열기` 선택
2. `robotmaster_C620.ino` 파일 선택

### 3. 업로드
1. **업로드** 버튼 클릭 (→ 아이콘)
2. "업로드 완료" 메시지 확인

### 4. 동작 확인
1. **도구 > 시리얼 모니터** 열기
2. Baud rate를 **115200**으로 설정
3. 초기화 메시지 확인

---

## 제어 프로그램 실행

### 1. Python 프로그램 실행
```bash
cd scripts
python3 servo_control_app.py
```

### 2. 프로그램이 실행되지 않는 경우
```bash
# PyQt5가 제대로 설치되었는지 확인
python3 -c "from PyQt5 import QtWidgets"

# pyserial 확인
python3 -c "import serial"

# 실행 권한 부여 (Linux/macOS)
chmod +x servo_control_app.py
./servo_control_app.py
```

---

## 사용 방법

### 1. 시리얼 포트 연결

1. **포트 선택**
   - 드롭다운 메뉴에서 Arduino가 연결된 포트 선택
   - Linux: `/dev/ttyACM0` 또는 `/dev/ttyUSB0`
   - Windows: `COM3`, `COM4` 등
   - macOS: `/dev/cu.usbmodem*`

2. **Baud Rate 설정**
   - 기본값 **9600** 사용 (변경 불필요)

3. **연결 버튼 클릭**
   - 상태가 "연결됨" (녹색)으로 변경되면 성공

### 2. 모터 제어

#### 개별 제어
- **슬라이더**: 마우스로 드래그하여 정밀 제어
- **스핀박스**: 숫자를 직접 입력 (10μs 단위)
- **프리셋 버튼**:
  - **최소 (1000)**: 최저 속도
  - **중앙 (1444)**: 정지 (중립)
  - **최대 (2000)**: 최고 속도

#### 통합 제어
- **정지**: 두 모터 모두 중립 (1444μs)
- **전진**: 두 모터 모두 최대 (2000μs)
- **후진**: 두 모터 모두 최소 (1000μs)
- **좌회전**: Motor1=2000μs, Motor2=1000μs
- **우회전**: Motor1=1000μs, Motor2=2000μs

### 3. 모니터링

#### 로그 창
- 모든 통신 내역 실시간 표시
- 타임스탬프와 함께 기록
- "로그 지우기" 버튼으로 초기화 가능

#### 프로토콜 정보
- 전송된 패킷의 16진수 표시
- 형식: `# [H1] [L1] [H2] [L2] *`

### 4. 안전 수칙 및 주의사항

⚠️ **반드시 준수하세요!**

#### 초기 설정 (매우 중요!)
1. **중립값 1444μs 확인**:
   - 시스템 부팅 시 자동으로 1444μs로 설정됩니다
   - "중앙" 버튼을 눌러 1444μs인지 재확인하세요
   - **이 값이 틀리면 모터가 절대 작동하지 않습니다!**

2. **첫 연결 절차**:
   ```
   ① C620 전원 OFF
   ② Arduino 펌웨어 업로드
   ③ Python 제어 프로그램 실행
   ④ 시리얼 포트 연결
   ⑤ "정지" 버튼 클릭 (1444μs 확인)
   ⑥ C620 전원 ON
   ⑦ 테스트 시작
   ```

#### 운영 중 안전 수칙
3. **첫 연결 시**: 모터가 자유롭게 회전할 수 있는지 확인
4. **정지 먼저**: 항상 "정지" 버튼으로 중립 상태 확인 후 조작
5. **점진적 변경**: 갑작스러운 속도 변화 금지 (한 번에 100μs 이내 권장)
6. **전원 차단**: 비상 시 즉시 C620 전원 차단
7. **배선 확인**: 전원 연결 상태 확인 후 작동

#### 🚨 절대 금지 사항
- ❌ 중립값을 1444μs가 아닌 다른 값으로 변경
- ❌ C620 전원을 켠 상태에서 신호선 탈착
- ❌ 모터에 물리적 부하가 걸린 상태에서 최대 속도 급작동
- ❌ GND 연결 없이 PWM 신호만 연결

---

## 문제 해결

### Q1. 시리얼 포트가 목록에 없어요
**해결 방법:**
1. Arduino USB 케이블이 제대로 연결되었는지 확인
2. Arduino 드라이버 설치 확인
3. Linux의 경우 권한 설정:
   ```bash
   sudo usermod -a -G dialout $USER
   # 로그아웃 후 재로그인
   ```

### Q2. 모터가 움직이지 않아요

**🔴 가장 흔한 원인: 중립값이 1444μs가 아님!**

**먼저 확인:**
1. ✅ **펄스 폭이 정확히 1444μs인가요?** ← 99% 이것이 문제!
   - GUI에서 "중앙(1444)" 버튼 클릭
   - 슬라이더가 정확히 1444 위치에 있는지 확인
   - 로그 창에서 "1444 μs" 확인

2. ✅ **1444μs에서 충분히 벗어났나요?**
   - 최소 1300μs 또는 최대 1600μs로 테스트
   - 1444μs는 정지 상태입니다!

**그래도 안 되면:**
3. ✓ C620 전원(24V)이 연결되어 있나요?
4. ✓ PWM 신호선이 올바른 핀에 연결되어 있나요?
5. ✓ Arduino GND와 C620 GND가 연결되어 있나요?
6. ✓ 모터가 C620에 제대로 연결되어 있나요?

**중립값 확인 방법:**
```bash
# Serial Monitor (115200 baud)에서 확인
left pulse width : 1444
right pulse width : 1444
```
위 메시지가 보이면 정상입니다.

### Q3. 모터가 반대로 회전해요
**해결 방법:**
- 한쪽 모터만 반대: C620의 모터 선 A/B/C 순서 변경
- 코드로 해결: `robotmaster_C620.ino`의 71번 라인 수식 수정

### Q4. 통신이 불안정해요
**해결 방법:**
1. USB 케이블을 다른 포트에 연결
2. 전원 공급 안정화 확인
3. 신호선 길이 최소화 (30cm 이내 권장)
4. GND 연결 확인

### Q5. "연결 실패" 오류가 나요
**해결 방법:**
```bash
# 포트 사용 중인 프로세스 확인 (Linux/macOS)
lsof | grep ttyACM0

# Serial Monitor가 열려있다면 닫기
# 다른 프로그램에서 포트를 사용 중이라면 종료
```

### Q6. GUI 프로그램이 실행되지 않아요
**해결 방법:**
```bash
# PyQt5 재설치
pip uninstall PyQt5
pip install PyQt5

# Python 버전 확인 (3.7 이상 필요)
python3 --version

# 의존성 확인
pip install -r requirements.txt
```

---

## 기술 사양

### 하드웨어 사양
| 항목 | 사양 |
|------|------|
| 마이크로컨트롤러 | ATmega2560 |
| PWM 출력 핀 | Digital Pin 2, 4 |
| 시리얼 포트 | Serial0 (USB), Serial1 (제어) |
| 타이머 사용 | Timer1 (16-bit) |

### 통신 프로토콜
```
형식: # [H1] [L1] [H2] [L2] *

- 시작 마커: # (0x23)
- Motor1 High Byte: [H1]
- Motor1 Low Byte: [L1]
- Motor2 High Byte: [H2]
- Motor2 Low Byte: [L2]
- 종료 마커: * (0x2A)
- 인코딩: Big-endian
- 패킷 길이: 6 바이트
```

### PWM 신호 사양
| 항목 | 값 | 비고 |
|------|-----|------|
| PWM 주기 | 15ms (66.7Hz) | |
| 펄스 폭 범위 | 1000~2000μs | |
| **중립값** | **1444μs** | **⚠️ C620 전용! 절대 변경 금지** |
| 타이머 분해능 | 0.5μs (2MHz) | |

#### ⚠️ 중립값 1444μs의 중요성

**C620 ESC는 다른 ESC와 다릅니다!**

| ESC 종류 | 중립값 | C620 호환성 |
|----------|--------|-------------|
| 일반 RC ESC | 1500μs | ❌ 작동 불가 |
| DJI C620 | **1444μs** | ✅ 정상 작동 |

**중립값이 틀리면:**
- 모터가 전혀 반응하지 않음
- 신호는 전송되지만 C620이 무시
- 에러 메시지 없이 조용히 실패

**이 시스템의 중립값 설정:**
- ✅ Arduino 부팅 시 자동 1444μs 설정
- ✅ Python GUI 시작 시 자동 1444μs 설정
- ✅ "정지" 버튼 → 1444μs 복귀
- ✅ "중앙" 버튼 → 1444μs 복귀

### 시리얼 통신 설정
| 항목 | Serial0 (디버그) | Serial1 (제어) |
|------|------------------|----------------|
| Baud Rate | 115200 bps | 9600 bps |
| Data Bits | 8 | 8 |
| Parity | None | None |
| Stop Bits | 1 | 1 |

### 모터 방향 설정
- **Motor 1 (왼쪽)**: 방향 반전 적용 (2888 - 입력값)
- **Motor 2 (오른쪽)**: 직접 제어

---

## 디렉토리 구조

```
Robotmaster_C620/
├── robotmaster_C620.ino       # Arduino 펌웨어
├── scripts/
│   └── servo_control_app.py   # PyQt5 제어 프로그램
├── ui/
│   └── servo_control.ui       # Qt Designer UI 파일
└── doc/
    └── USER_MANUAL.md         # 이 파일
```

---

## 지원 및 문의

- **GitHub 저장소**: https://github.com/kuks2309/wall_climbing_robot
- **이슈 등록**: GitHub Issues 탭 이용
- **버전**: 1.0
- **최종 업데이트**: 2025

---

## 라이선스

이 프로젝트는 MIT 라이선스를 따릅니다.

---

## 변경 이력

### v1.0 (2025)
- 초기 릴리스
- DJI C620 제어 기능 구현
- PyQt5 GUI 애플리케이션
- Big-endian 프로토콜 적용
- serialEvent1() 이벤트 기반 처리
